# 修正計画の批判的レビュー: Discord通知のコンパクト化と重複修正

## レビュー日時
2025-01-27

## レビュー対象
`plans/specs/requirements/discord-notification-compact-fix.md`

---

## 🔴 重大な問題点

### 1. 重複問題の根本原因分析が不十分

**問題**:
- 要件定義では「`GroupBy(n => n.SubmarineId)`で重複が発生している」と仮定している
- しかし、実際のコードを見ると：
  ```csharp
  state.Underway[notification.SubmarineId] = notification;  // Dictionaryなので上書きされる
  ```
- `state.Underway`は`Dictionary<SubmarineId, VoyageNotification>`なので、同じSubmarineIdの通知は**上書き**される
- `TryCreateAggregate`では`.Values`から取得しているので、Dictionaryには既に重複は存在しない

**真の原因の可能性**:
1. **Slot番号の不一致**: 
   - `DalamudMemorySubmarineSnapshotSource`では`(byte)(i + 1)`でSlotを作成（1-5）
   - `DalamudUiSubmarineSnapshotSource`では`nodeId`からSlotを作成（0-3、またはPendingSlot）
   - メモリソースとUIソースでSlot番号が異なる可能性
   
2. **SubmarineIdの生成ロジック**:
   - `CreateSubmarineId`で`nodeId <= byte.MaxValue`の場合のみ有効なSlot
   - `slot >= 4`の場合は`PendingSlot`になる
   - しかし、メモリソースでは`i + 1`なので、5番目の潜水艦はSlot 5になり、これは`PendingSlot`に変換される可能性

3. **通知のタイミング**:
   - 同じ潜水艦から複数の通知が来た場合、Dictionaryに上書きされる
   - しかし、異なるタイミングで同じSubmarineIdの通知が来た場合、最新のものだけが残る
   - 3隻目と4隻目が同じになるのは、実際には同じSubmarineIdが2回追加されている可能性

**推奨修正**:
- 根本原因を特定するため、ログを追加して実際のSubmarineIdとSlot番号を確認
- `TryCreateAggregate`で重複チェックを追加する前に、`state.Underway`に追加される段階でログを出力
- Slot番号の正規化を確認（0-3の範囲に統一）

---

### 2. コンパクト化の設計に問題

**問題**:
- 説明フィールドに全情報を入れるのは良いが、以下の問題がある：
  1. **リマインダーコマンドのコピペ性**: 説明フィールドに入れると、コピペしにくくなる
  2. **Discordの表示**: 説明フィールドは長文になると読みにくい
  3. **既存の設計思想**: Phase 13でフィールドを使う設計にした理由があるはず

**現状の設計**:
- 各潜水艦が個別のフィールド（inline=true）で横並び表示
- これはDiscordのembedの標準的な使い方
- フィールドは最大25個まで可能

**推奨修正**:
- 説明フィールドに全情報を入れるのではなく、以下のいずれかを検討：
  1. **フィールドを維持しつつ、情報を簡潔に**: 各フィールドの値を短くする
  2. **説明フィールドに要約のみ**: 全情報はフィールドに残し、説明には「4隻出航」などの要約のみ
  3. **ハイブリッド**: 説明に要約、フィールドに詳細（ただし簡潔に）

---

### 3. テストシナリオが不十分

**問題**:
- `TS-2`のテストでは、正常系（4隻すべて異なるSubmarineId）しかテストしていない
- 異常系（重複がある場合）のテストがない
- 実際の問題（3隻目と4隻目が同じ）を再現するテストがない

**推奨修正**:
- 以下のテストケースを追加：
  1. 同じSubmarineIdの通知が複数来た場合の動作
  2. Slot番号が重複している場合の動作
  3. 3隻目と4隻目が同じSubmarineIdになるケースの再現テスト

---

## 🟡 中程度の問題点

### 4. 受け入れ基準が曖昧

**問題**:
- 「スクロールなしで全体が見える」という基準が主観的
- Discordの表示はクライアントによって異なる（デスクトップ、モバイル、Web）
- どの環境で「見える」と判断するか不明確

**推奨修正**:
- 具体的な文字数制限を設定（例: 説明フィールドは200文字以内）
- または、Discordのembed仕様に基づいた制限を明記

---

### 5. リスク分析が不十分

**問題**:
- 「説明フィールドが長すぎる」リスクは記載されているが、具体的な対策がない
- 「重複チェックのロジックエラー」のリスクは記載されているが、根本原因が不明確なまま実装するリスクが高い

**推奨修正**:
- 根本原因を特定してから実装することを推奨
- または、段階的なアプローチ（まずログ追加→原因特定→修正）を提案

---

### 6. 影響範囲の分析が不十分

**問題**:
- `DiscordCycleNotificationAggregator`の変更だけでなく、データソース側（`DalamudMemorySubmarineSnapshotSource`、`DalamudUiSubmarineSnapshotSource`）の変更も必要かもしれない
- Slot番号の正規化が影響範囲に含まれていない

**推奨修正**:
- データソース側のSlot番号生成ロジックも確認
- 必要に応じて、Slot番号の正規化を追加

---

## 🟢 軽微な問題点

### 7. フォーマット例が不正確

**問題**:
- 新フォーマット例で「Sub-1: 10/26 14:30 (12h)」としているが、実際の`FormatLocalTimestamp`は「M/d(ddd) HH:mm」形式（例: "10/26(土) 14:30"）
- 曜日が含まれるかどうかが不明確

**推奨修正**:
- 実際のフォーマット関数の出力に合わせて例を修正

---

### 8. 日付フォーマットの一貫性

**問題**:
- 要件定義では「MM/dd HH:mm」形式を想定しているが、実装では「M/d(ddd) HH:mm」形式
- フォーマットの統一が必要

**推奨修正**:
- 既存の`FormatLocalTimestamp`の出力形式を確認し、要件定義を修正

---

## 📋 推奨される修正アプローチ

### Phase 1: 根本原因の特定（必須）

1. **ログの追加**:
   ```csharp
   // DiscordCycleNotificationAggregator.Process に追加
   this.log.Log(LogLevel.Debug, 
       $"[Notifications] Processing notification: SubmarineId={notification.SubmarineId} " +
       $"Slot={notification.SubmarineId.Slot} Label={notification.SubmarineLabel} " +
       $"HashKey={notification.HashKey}");
   ```

2. **重複検出ロジックの追加**:
   ```csharp
   // TryCreateAggregate に追加
   var duplicateIds = aggregate.GroupBy(n => n.SubmarineId)
       .Where(g => g.Count() > 1)
       .ToList();
   if (duplicateIds.Any())
   {
       this.log.Log(LogLevel.Warning,
           $"[Notifications] Duplicate SubmarineIds detected: {string.Join(", ", duplicateIds.Select(g => g.Key))}");
   }
   ```

3. **Slot番号の検証**:
   - データソース側でSlot番号が0-3の範囲に正規化されているか確認
   - メモリソースとUIソースでSlot番号が一致しているか確認

### Phase 2: コンパクト化の再設計（推奨）

1. **現状のフィールド形式を維持**:
   - 各潜水艦を個別のフィールドとして表示（inline=true）
   - ただし、フィールドの値をより簡潔に（例: "10/26 14:30 (12h)"）

2. **説明フィールドの活用**:
   - 説明フィールドには要約のみ（例: "4隻出航"）
   - 詳細はフィールドに残す

3. **リマインダーコマンド**:
   - 別フィールドとして維持（コピペしやすくするため）
   - または、説明フィールドの最後に追加（ただし、コピペしやすい形式で）

### Phase 3: 実装とテスト

1. **根本原因を修正**:
   - Slot番号の正規化
   - 重複チェックの強化

2. **コンパクト化の実装**:
   - フィールドの値を簡潔に
   - 説明フィールドの活用

3. **テストの追加**:
   - 異常系のテスト
   - 重複ケースの再現テスト

---

## ✅ 良い点

1. **問題の明確化**: 2つの問題（冗長性、重複）を明確に分離している
2. **受け入れ基準**: 具体的な基準を設定している
3. **テストシナリオ**: 基本的なテストケースを提供している
4. **影響範囲**: 変更対象ファイルを明確にしている

---

## 🎯 最終推奨事項

### 即座に実施すべきこと

1. **根本原因の特定**: ログを追加して、実際に3隻目と4隻目が同じSubmarineIdになっているか確認
2. **Slot番号の検証**: データソース側でSlot番号が正しく生成されているか確認
3. **段階的なアプローチ**: 根本原因を特定してから、コンパクト化を実施

### 再検討すべきこと

1. **コンパクト化の設計**: 説明フィールドに全情報を入れるのではなく、フィールドを維持しつつ簡潔にする
2. **リマインダーコマンド**: コピペしやすさを優先し、別フィールドとして維持

### 追加すべきこと

1. **異常系のテスト**: 重複ケースの再現テスト
2. **ログの追加**: デバッグ用のログを追加
3. **Slot番号の正規化**: データソース側でのSlot番号の統一

---

**レビュー担当**: AI Assistant  
**レビュー日時**: 2025-01-27  
**推奨アクション**: 根本原因の特定を優先し、コンパクト化は再設計を推奨

