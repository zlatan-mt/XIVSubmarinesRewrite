# 潜水艦名重複問題に関する根本原因分析レポート（追補）

## 1. 総括

### 1.1. 結論

前回の修正で導入されたメモリ名の揺らぎ抑制（デバウンス）や通知発行の遅延といった多層防御は、部分的に機能している。しかし、それを**バイパスする未知の根本原因**が存在することが、今回のログで明らかになった。

新たな根本原因は、**`CharacterSnapshotAggregator` の内部状態が、過去に存在し今は無効な潜水艦スロット（例：5隻目、6隻目）の永続化されたデータによって初期汚染されている**ことにある。

この「ゴーストデータ」の存在が `MemoryDataSource` の読み取り処理に悪影響を与え、**正しい潜水艦スロット（例：3番艦）に対して、別の潜水艦（例：2番艦）の情報を紐付けてしまう「ゴースト更新」**を発生させている。このゴースト更新は、名前だけでなく`voyage.Id`も偽装しているため、Voyage IDをキーとする名前デバウンス機能が効かず、データ破損が防げない。

### 1.2. 新たな問題の連鎖

1.  **初期状態の汚染:** プラグイン起動時、`CharacterSnapshotAggregator`は永続化されたキャッシュから潜水艦データを読み込む。この際、現在は存在しないはずの**4番以上のスロットを持つ潜水艦データ（ゴーストデータ）**がロードされ、内部状態が6隻の潜水艦を持つ異常な状態になる。
    - **証拠:** `12:00:27.610`のログでは、キャラクター`18014398541695383`に対して6隻の潜水艦がロードされている。
2.  **ゴースト更新の発生:** `MemoryDataSource`が、**3番艦（ID: `...:3`）**のデータを読み取る際に、何らかの理由で**2番艦（Pilvi）**の情報を読み込んでしまう。この更新は、名前(`Pilvi`)だけでなく、`voyage.Id`も2番艦のものを含んでいる。
    - **証拠:** `12:02:46.574`のログで、`id=...:3`の名前が`Kukka`から`Pilvi`に変わっている。
3.  **デバウンス機能の無効化:** `MemoryDataSource`に実装された名前デバウンス機能は、`voyage.Id`をキーにしている。ゴースト更新は`voyage.Id`自体が異なるため、「別の航海のデータ」として扱われ、名前の揺らぎとして検知されずに通過してしまう。
    - **証拠:** `12:02:46.574`の`SnapshotDiffer`のログは、差分検知の理由を`reason=voyage-id`としており、`voyage.Id`が変わったことを示している。
4.  **データ破損と重複通知:** `Aggregator`のデータが`id=...:3, name=Pilvi`で上書きされ、内部的に`name=Pilvi`の潜水艦が2隻（`id=...:2`と`id=...:3`）存在する状態になる。これが`SnapshotDiffer`に検知され、後続の`VoyageCompletionProjection`が2隻の`Pilvi`に対して通知を発行する。
    - **証拠:** `12:02:50.585`のログで、`id=...:2` (`Pilvi`)と`id=...:3` (`Pilvi`)の両方に対して`ForceNotifyUnderway enqueuing voyage`が記録されている。
5.  **重複の集約:** 最終的に`DiscordCycleNotificationAggregator`が、これらの重複した通知を集約し、ユーザーに報告された「3隻目と4隻目が被る」という現象が完成する。
    - **証拠:** `12:02:50.612`のログで、`slots=[Slot4:Kukka, Slot1:Siipi, Slot2:Pilvi, Slot3:Pilvi]`という重複した内容の集約が作成されている。

### 1.3. 画面UIとの不整合について

ユーザー報告の「画面UIを確認すると、4隻目が帰港になったまま変化していません」という状況は、この分析を裏付けている。UI上は4番艦（Kukka）は正常に見えるが、内部データだけがゴースト更新によって汚染され、「4番艦の名前がPilviに変わった」という誤った変更通知が発行されているためである。

---

## 2. 根本原因の再定義

真の根本原因は、**永続化キャッシュ（snapshot.json等）内に、現在は使用されていない無効なスロットIDを持つ「ゴースト潜水艦」のデータが残留していること**である。

このゴーストデータが `CharacterSnapshotAggregator` の初期状態を汚染し、`MemoryDataSource` の挙動を不安定にさせ、結果として実装された各種防御機構をすり抜けるデータ破損を引き起こしている。

---

## 3. 修正方針の提案

データ破損の連鎖を断ち切るため、以下の段階的な修正を提案する。

### 3.1. 必須修正：データのクレンジング（浄化）

最も重要な対策は、汚染源であるゴーストデータをシステムから完全に排除することである。

-   **方針:** プラグイン起動時、`CharacterSnapshotAggregator`が永続化キャッシュからデータをロードした直後に、**スロット番号が0-3の範囲外である潜水艦データをすべて破棄する**クレンジング処理を追加する。
-   **期待される効果:** これにより、システムの内部状態が常に正規の潜水艦（最大4隻）のみを扱うことが保証され、ゴーストデータに起因するすべての異常動作（ゴースト更新、`Invalid Slot`警告など）が解消される。

### 3.2. 推奨される追加対策：メモリ読み取りの厳格化

再発防止のため、メモリ読み取り自体の信頼性を向上させる。

-   **方針:** `DalamudMemorySubmarineSnapshotSource`のメモリスキャン処理を見直し、ゲーム内でプレイヤーが実際に所有している潜水艦の数（最大4隻）を超えてメモリを読み取らないように、ループ範囲を厳格に制限する。
-   **期待される効果:** たとえキャッシュが何らかの理由で汚染されたとしても、メモリソース自体が不正なデータを生成する可能性を低減させ、システムの堅牢性をさらに高める。
