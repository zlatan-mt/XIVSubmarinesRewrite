# 4隻目の潜水艦ステータスが更新されない問題に関する調査レポート

## 1. 問題の概要

ユーザーより、「4隻目の潜水艦のみ、出航後もステータスが『帰港』のままで、帰港予定時刻が更新されない」という問題が報告されました。

## 2. 根本原因の特定

コードベースを調査した結果、根本原因は**UIデータ取得処理におけるフィルタリングロジックの副作用**であると特定しました。

具体的には、ゲーム内UIから潜水艦のリストを読み取る際、4隻目の潜水艦データが「信頼度が低い」と誤判定され、処理対象から除外されていました。その結果、4隻目についてはUIからの「航海中」という最新情報が反映されず、代わりに内部メモリに残っていた古い「帰港」状態が使われ続けてしまう、という現象が発生しています。

### 問題発生のメカニズム

1.  **UI候補のリストアップ:** ゲーム内の潜水艦リストUIから、潜水艦4隻と「やめる」などの操作項目を含んだ5行以上の候補リストが作成されます。
2.  **信頼度スコアの計算:** 各行に対して、`ComputeRowConfidence` メソッド（後述）が「その行が潜水艦のデータとしてどれだけ確からしいか」を点数化します。
3.  **スコアの低い4隻目:** 何らかの理由で、4隻目の行データに対してのみ、この信頼度スコアが不当に低く計算されます。
4.  **候補のフィルタリング:** 候補リストはスコア順に並べ替えられた後、上位4件のみが採用されます。この時、スコアの低い4隻目は5番目以降に追いやられ、**ノイズとして誤って破棄**されます。
5.  **古いデータの参照:** UIからのデータが3隻分しか存在しないため、データ統合処理（`CharacterSnapshotAggregator`）は、4隻目の情報としてUI以外のデータソース（＝古い「帰港」情報が残っているメモリデータ）を参照してしまいます。

## 3. 原因の核心箇所

この問題の直接的な原因となっているのは、信頼度スコアを計算するロジックの脆弱性です。

-   **関連ファイル:** `src/Infrastructure/Acquisition/DalamudUiSubmarineSnapshotSource.RowExtraction.Helpers.cs`
-   **関連メソッド:** `private int ComputeRowConfidence(RowInfo row)`

このメソッドは、行に含まれるテキスト（「残り時間」「Rank」など）のパターンを基にスコアを計算しますが、現在のロジックでは、4隻目の潜水艦のテキストパターンを正しく評価できず、低いスコアを付けてしまっていると強く推測されます。

これは、特定のインデックス（例：`i < 3`）を扱うような単純なバグではなく、**データのパターンに対するスコアリングロジックの考慮漏れ**が原因です。

## 4. 修正方針の提案

この問題を解決するには、コードの変更が必要となりますが、以下に修正方針を提案します。

1.  **デバッグ:** 実際のゲームUIで4隻目の潜水艦の行がどのようなテキストで構成されているかを正確に特定します。
2.  **スコアリングロジックの修正:** `ComputeRowConfidence` メソッドを修正し、4隻目のテキストパターンでも他の潜水艦と同様に高い信頼度スコアが計算されるようにロジックを調整します。具体的には、スコアを加算する条件を緩和するか、4隻目特有のパターンを新たな条件として追加することが考えられます。

以上が調査結果となります。
