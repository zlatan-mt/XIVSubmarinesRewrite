# タスク分解: 通知リトライボタンのツールチップ追加

## タスク概要

要件と設計に基づき、実装タスクを1-3日で完了可能な粒度に分解。各タスクには見積もり、優先度、依存関係を明記。

---

## タスク1: コア実装

### 1.1 RetryTooltipFormatter 実装
**優先度**: 高  
**見積もり**: 4時間  
**担当**: 開発者  
**依存**: なし

**概要**:  
ツールチップ内容を生成する静的ユーティリティクラスを実装。

**実装内容**:
- [ ] `RetryTooltipFormatter.cs` ファイル作成
- [ ] `Format()` メソッド実装
  - 入力: `NotificationDeliveryRecord`, `DateTime now`, `UiTheme`
  - 出力: `TooltipContent`
- [ ] `FormatRetryCount()` プライベートメソッド
- [ ] `FormatNextAttempt()` プライベートメソッド
- [ ] `TooltipContent` record定義
- [ ] `TooltipLine` record定義

**受け入れ基準**:
- [ ] リトライ回数が正しくフォーマットされる
- [ ] 最終試行時刻が `yyyy-MM-dd HH:mm:ss` 形式
- [ ] 次回試行までの秒数が計算される
- [ ] デッドレター状態が判別される
- [ ] 履歴なしケースが処理される

**テスト**:
- [ ] 単体テスト: `RetryTooltipFormatterTests.cs` (5ケース以上)

---

### 1.2 NotificationMonitorWindowRenderer 部分クラス追加
**優先度**: 高  
**見積もり**: 3時間  
**担当**: 開発者  
**依存**: 1.1

**概要**:  
ツールチップ描画ロジックを部分クラスとして追加。

**実装内容**:
- [ ] `NotificationMonitorWindowRenderer.RetryTooltip.cs` ファイル作成
- [ ] `DrawRetryButtonWithTooltip()` メソッド実装
- [ ] `DrawRetryTooltip()` メソッド実装
- [ ] `DrawTooltipLine()` メソッド実装
- [ ] ImGui API統合
  - `ImGui.BeginTooltip()`
  - `ImGui.EndTooltip()`
  - `ImGui.IsItemHovered()`

**受け入れ基準**:
- [ ] ホバー時にツールチップが表示される
- [ ] ツールチップ内容が正しく描画される
- [ ] 区切り線が表示される
- [ ] エラー色が正しく適用される
- [ ] 例外が適切にハンドリングされる

**テスト**:
- [ ] E2Eテスト: ツールチップ表示確認（Playwright）

---

### 1.3 既存コードの統合
**優先度**: 高  
**見積もり**: 2時間  
**担当**: 開発者  
**依存**: 1.2

**概要**:  
既存の `DrawRetryButton()` を新しい実装に置き換え。

**実装内容**:
- [ ] `NotificationMonitorWindowRenderer.cs` の `DrawRetryButton()` を修正
- [ ] 既存の呼び出し元を確認
- [ ] ログ出力追加（デバッグ用）

**受け入れ基準**:
- [ ] 既存の通知タブ動作が維持される
- [ ] リトライボタンのクリック動作が正常
- [ ] ツールチップ表示が既存UIと調和

---

## タスク2: テスト実装

### 2.1 単体テスト: RetryTooltipFormatter
**優先度**: 高  
**見積もり**: 3時間  
**担当**: 開発者  
**依存**: 1.1

**概要**:  
`RetryTooltipFormatter` の包括的な単体テストを作成。

**テストケース**:
- [ ] TC-1: 通常のリトライ履歴
- [ ] TC-2: デッドレター状態
- [ ] TC-3: リトライ履歴なし
- [ ] TC-4: 次回試行スケジュール済み
- [ ] TC-5: エラーメッセージ付き
- [ ] TC-6: エッジケース（null値、境界値）

**受け入れ基準**:
- [ ] すべてのテストがパスする
- [ ] コードカバレッジ 95%以上
- [ ] テスト実行時間 < 1秒

**成果物**:
- [ ] `tests/XIVSubmarinesRewrite.Tests/RetryTooltipFormatterTests.cs`

---

### 2.2 E2Eテスト: ツールチップ表示
**優先度**: 中  
**見積もり**: 4時間  
**担当**: 開発者  
**依存**: 1.3

**概要**:  
Playwright でツールチップの表示と内容を検証。

**テストケース**:
- [ ] TC-1: ツールチップがホバーで表示される
- [ ] TC-2: リトライ回数が表示される
- [ ] TC-3: 最終試行時刻が表示される
- [ ] TC-4: デッドレター状態が表示される
- [ ] TC-5: ホバー解除でツールチップが消える

**受け入れ基準**:
- [ ] すべてのテストがパスする
- [ ] テストが安定している（フレーキーでない）
- [ ] スクリーンショット証跡がある

**成果物**:
- [ ] `tests/Playwright/notification-layout.spec.ts` に追加

---

## タスク3: パフォーマンス最適化

### 3.1 パフォーマンス測定
**優先度**: 中  
**見積もり**: 2時間  
**担当**: 開発者  
**依存**: 1.3

**概要**:  
ツールチップ描画のパフォーマンスを測定し、ボトルネックを特定。

**測定項目**:
- [ ] ツールチップ生成時間（Stopwatch）
- [ ] 描画時間（Dalamud Profiler）
- [ ] メモリアロケーション（Memory Profiler）
- [ ] フレームレート影響

**受け入れ基準**:
- [ ] 生成時間 < 100μs
- [ ] 描画時間 < 500μs
- [ ] メモリアロケーション < 1KB
- [ ] 60fps維持

**成果物**:
- [ ] パフォーマンスレポート（Markdown）

---

### 3.2 キャッシュ実装（オプション）
**優先度**: 低  
**見積もり**: 2時間  
**担当**: 開発者  
**依存**: 3.1

**概要**:  
パフォーマンス測定の結果、必要であればキャッシュを実装。

**実装内容**:
- [ ] ツールチップ内容のキャッシュ（1秒間）
- [ ] キャッシュ無効化ロジック
- [ ] メモリリーク防止

**受け入れ基準**:
- [ ] キャッシュヒット時、生成時間 < 10μs
- [ ] メモリリークがない
- [ ] リアルタイム更新が正常動作

**成果物**:
- [ ] キャッシュロジック追加

---

## タスク4: ドキュメント整備

### 4.1 コード内コメント
**優先度**: 中  
**見積もり**: 1時間  
**担当**: 開発者  
**依存**: 1.3

**概要**:  
XML コメントと説明コメントを追加。

**実装内容**:
- [ ] `RetryTooltipFormatter` にXMLコメント
- [ ] パブリックメソッドに説明
- [ ] 複雑なロジックに意図を明記

**受け入れ基準**:
- [ ] すべてのパブリックメンバーにXMLコメント
- [ ] IntelliSenseで表示される
- [ ] コメント内容が正確

---

### 4.2 完了レポート作成
**優先度**: 低  
**見積もり**: 1時間  
**担当**: 開発者  
**依存**: 2.2, 3.1

**概要**:  
Phase 12-C 完了レポートを作成。

**記載内容**:
- [ ] 実装内容サマリー
- [ ] テスト結果
- [ ] パフォーマンス測定結果
- [ ] スクリーンショット
- [ ] 学びと改善点

**成果物**:
- [ ] `plans/PHASE12C_COMPLETION_REPORT.md`

---

## タスク5: リリース準備

### 5.1 コードレビュー
**優先度**: 高  
**見積もり**: 2時間  
**担当**: レビュアー  
**依存**: 1.3, 2.1, 2.2

**レビュー観点**:
- [ ] コーディング規約準拠
- [ ] パフォーマンス要件達成
- [ ] テストカバレッジ 90%以上
- [ ] セキュリティ考慮
- [ ] ドキュメント整備

---

### 5.2 マージとデプロイ
**優先度**: 高  
**見積もり**: 1時間  
**担当**: 開発者  
**依存**: 5.1

**実施内容**:
- [ ] feature ブランチから develop へマージ
- [ ] CI パス確認
- [ ] develop から release へマージ（適切なタイミングで）

---

## タスク依存関係図

```
タスク1: コア実装
  1.1 RetryTooltipFormatter
    ↓
  1.2 部分クラス追加
    ↓
  1.3 既存コード統合
    ↓
  ┌─────┴─────┐
  ↓           ↓
タスク2       タスク3
単体テスト    パフォーマンス
  2.1           3.1
  2.2           3.2
  ↓           ↓
  └─────┬─────┘
        ↓
      タスク4
    ドキュメント
        4.1
        4.2
        ↓
      タスク5
    リリース準備
        5.1
        5.2
```

---

## 見積もりサマリー

| フェーズ | タスク数 | 合計時間 | 優先度 |
|----------|---------|---------|--------|
| タスク1: コア実装 | 3 | 9時間 | 高 |
| タスク2: テスト | 2 | 7時間 | 高/中 |
| タスク3: 最適化 | 2 | 4時間 | 中/低 |
| タスク4: ドキュメント | 2 | 2時間 | 中/低 |
| タスク5: リリース | 2 | 3時間 | 高 |
| **合計** | **11** | **25時間** | - |

**推定期間**: 3-4営業日（1日6-8時間換算）

---

## 実装順序（推奨）

### Day 1: コア実装
- AM: タスク 1.1 (4h)
- PM: タスク 1.2 (3h) + 1.3 (2h) 開始

### Day 2: テスト
- AM: タスク 1.3 完了 + 2.1 (3h)
- PM: タスク 2.2 (4h)

### Day 3: 最適化とドキュメント
- AM: タスク 3.1 (2h) + 3.2 (2h)
- PM: タスク 4.1 (1h) + 4.2 (1h) + 5.1 (2h)

### Day 4: リリース
- AM: タスク 5.2 (1h) + 予備時間

---

## リスクと軽減策

| リスク | 影響 | 確率 | 軽減策 |
|--------|------|------|--------|
| ImGui API の不具合 | 高 | 低 | 公式ドキュメント確認、サンプルコード参照 |
| パフォーマンス要件未達 | 中 | 中 | 早期測定、キャッシュ実装 |
| E2Eテストのフレーキー | 低 | 中 | waitForTimeout調整、リトライロジック |
| 既存機能への影響 | 高 | 低 | 回帰テスト実施、フィーチャーフラグ |

---

## 成功基準

### 必須（Must Have）
- [ ] リトライボタンにツールチップが表示される
- [ ] リトライ回数と最終試行時刻が正確
- [ ] 60fps が維持される
- [ ] テストカバレッジ 90%以上
- [ ] コードレビューパス

### 推奨（Should Have）
- [ ] デッドレター状態の表示
- [ ] リアルタイムカウントダウン
- [ ] パフォーマンス最適化

### オプション（Nice to Have）
- [ ] キャッシュ実装
- [ ] アニメーション効果

---

**作成日**: 2025-10-26  
**見積もり精度**: ±20%  
**優先順位**: Phase 12-C 試験運用  
**次のステップ**: タスク 1.1 から実装開始

