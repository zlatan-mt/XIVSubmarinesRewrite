# タスク分解: Discord通知メッセージの最適化

## タスク概要

要件と設計に基づき、Discord通知の最適化を3つのフェーズに分けて実装。
各タスクは1-3日で完了可能な粒度に分解し、段階的なリリースを可能にする。

**総見積もり**: 18-22時間（3-4営業日）  
**優先度**: 中  
**Phase**: Phase 13候補

---

## タスク1: Completed通知の停止

### 1.1 VoyageCompletionProjection でCompleted通知をフィルタ
**優先度**: 高  
**見積もり**: 2時間  
**担当**: 開発者  
**依存**: なし

**概要**:  
`VoyageCompletionProjection` でCompleted状態の通知送信をスキップするロジックを追加。

**実装内容**:
- [ ] `VoyageCompletionProjection.cs` を修正
- [ ] Completed判定でログ出力のみ（通知送信しない）
- [ ] デバッグログ追加（どの通知がスキップされたか記録）
- [ ] 既存のUnderway通知ロジックは維持

**受け入れ基準**:
- [ ] Completed通知が送信されない
- [ ] Underway通知は正常に送信される
- [ ] ログにスキップ理由が記録される
- [ ] 既存のバッチング機能が正常動作

**テスト**:
- [ ] 単体テスト: Completed状態で通知が送信されないことを確認
- [ ] 統合テスト: Underway → Completed のフロー

**成果物**:
- [ ] `VoyageCompletionProjection.cs` または `VoyageCompletionProjection.ForceNotify.cs` の修正

---

### 1.2 設定UIからNotifyVoyageCompleted削除
**優先度**: 中  
**見積もり**: 1時間  
**担当**: 開発者  
**依存**: 1.1

**概要**:  
通知設定フォームから「帰港時に通知」チェックボックスを削除。

**実装内容**:
- [ ] `NotificationMonitorWindowRenderer.SettingsLayout.cs` を修正
- [ ] チェックボックスをコメントアウトまたは削除
- [ ] レイアウトを調整

**受け入れ基準**:
- [ ] 「帰港時に通知」チェックボックスが表示されない
- [ ] UIレイアウトが崩れない
- [ ] 既存の設定保存機能が正常動作

**テスト**:
- [ ] E2Eテスト: 設定フォームの表示確認

---

### 1.3 NotifyVoyageCompleted をdeprecated化
**優先度**: 低  
**見積もり**: 30分  
**担当**: 開発者  
**依存**: 1.1

**概要**:  
`NotificationSettings` の `NotifyVoyageCompleted` に `[Obsolete]` 属性を追加。

**実装内容**:
- [ ] `NotificationSettings.cs` を修正
- [ ] `[Obsolete("Completed notifications are no longer sent")]` 追加
- [ ] ドキュメントコメント更新

**受け入れ基準**:
- [ ] プロパティが読み込み可能（後方互換性）
- [ ] 使用時にコンパイラ警告が出る
- [ ] 設定ファイルの読み書きが正常

---

## タスク2: フォーマット簡素化

### 2.1 FormatRemainingConcise() 実装
**優先度**: 高  
**見積もり**: 2時間  
**担当**: 開発者  
**依存**: なし

**概要**:  
残り時間を簡潔にフォーマットする新しいユーティリティメソッドを実装。

**実装内容**:
- [ ] `VoyageNotificationFormatter.cs` に追加
- [ ] フォーマットロジック
  - 1時間未満: `30m`
  - 1時間以上: `12h`, `12.5h`（0.5刻み）
- [ ] エッジケース処理
  - null: `"0m"`
  - 負の値: `"0m"`
  - 14日超過: `"14d+"`

**受け入れ基準**:
- [ ] 25分 → "25m"
- [ ] 1時間 → "1h"
- [ ] 1.5時間 → "1.5h"
- [ ] 12時間40分 → "12.5h"（四捨五入）

**テスト**:
- [ ] 単体テスト: 10ケース以上（境界値、異常値含む）

---

### 2.2 単体通知フォーマットの簡素化
**優先度**: 高  
**見積もり**: 3時間  
**担当**: 開発者  
**依存**: 2.1

**概要**:  
`CreateDiscordPayload()` を簡素化し、1フィールドのみの通知を生成。

**実装内容**:
- [ ] `CreateDiscordPayload()` メソッドを修正
- [ ] Underway専用に（Completedは例外スロー）
- [ ] フィールドを1個に削減
  - タイトル: `[潜水艦名] 出航`
  - 説明: `[航路名]`
  - フィールド: `帰還予定: [日時] ([残り時間])`
- [ ] `BuildDiscordFields()` を削除または大幅簡素化

**受け入れ基準**:
- [ ] タイトルが `"Sub-1 出航"` 形式
- [ ] 説明が航路名のみ
- [ ] フィールドが1個
- [ ] 帰還予定に残り時間が含まれる
- [ ] Completed通知で例外がスローされる

**テスト**:
- [ ] 単体テスト: フォーマット検証
- [ ] 単体テスト: Completed例外確認

---

### 2.3 バッチ通知フォーマットの簡素化
**優先度**: 高  
**見積もり**: 3時間  
**担当**: 開発者  
**依存**: 2.1

**概要**:  
`CreateDiscordBatchPayload()` を修正し、1行×N隻の簡潔な通知を生成。

**実装内容**:
- [ ] `CreateDiscordBatchPayload()` メソッドを修正
- [ ] Underway専用に（Completedは例外スロー）
- [ ] タイトル: `[キャラクター名] - [N]隻出航`
- [ ] 説明: 空欄
- [ ] フィールド: 各潜水艦1フィールド
  - Name: `[潜水艦名]`
  - Value: `[日時] ([残り時間])`
  - Inline: `true`（横並び可能に）
- [ ] `BuildBatchLines()` を削除

**受け入れ基準**:
- [ ] タイトルに隻数が含まれる
- [ ] 各潜水艦が1フィールド
- [ ] 4隻で4フィールド（スクロールなし）
- [ ] 時刻フォーマットが統一

**テスト**:
- [ ] 単体テスト: 1隻、2隻、4隻でフォーマット確認
- [ ] 単体テスト: Completed例外確認

---

## タスク3: Discord Reminder Bot 統合（オプション）

### 3.1 FormatReminderCommand() 実装
**優先度**: 中  
**見積もり**: 2時間  
**担当**: 開発者  
**依存**: なし

**概要**:  
Discord Reminder Bot用のコマンド文字列を生成するユーティリティを実装。

**実装内容**:
- [ ] `VoyageNotificationFormatter.cs` に追加
- [ ] コマンド生成ロジック
  - フォーマット: `/remind [channel] [time] [message]`
  - チャンネル名バリデーション（#プレフィックス確認）
  - メッセージサニタイズ（改行削除、100文字制限）
- [ ] 時刻フォーマット: `M/d HH:mm`（Reminder Bot準拠）

**受け入れ基準**:
- [ ] コマンドが `/remind #submarine 10/26 14:30 Sub-1が帰還` 形式
- [ ] チャンネル名が#で始まる
- [ ] メッセージに改行がない
- [ ] メッセージが100文字以内

**テスト**:
- [ ] 単体テスト: コマンド生成検証
- [ ] 単体テスト: サニタイズ確認（改行、長文）

---

### 3.2 単体通知にリマインダーコマンド追加
**優先度**: 中  
**見積もり**: 1.5時間  
**担当**: 開発者  
**依存**: 3.1, 2.2

**概要**:  
単体通知にリマインダーコマンドフィールドを追加（設定で有効化）。

**実装内容**:
- [ ] `CreateDiscordPayload()` にリマインダーフィールド追加
- [ ] `EnableReminderCommand` 設定で条件分岐
- [ ] `ReminderChannelName` 設定を使用

**受け入れ基準**:
- [ ] 設定有効時にリマインダーフィールドが追加される
- [ ] 設定無効時はフィールドなし
- [ ] コマンドがコピペ可能

**テスト**:
- [ ] 単体テスト: 設定ON/OFFでフィールド数確認

---

### 3.3 バッチ通知にリマインダーコマンド追加
**優先度**: 中  
**見積もり**: 1.5時間  
**担当**: 開発者  
**依存**: 3.1, 2.3

**概要**:  
バッチ通知にリマインダーコマンドフィールドを追加。

**実装内容**:
- [ ] `CreateDiscordBatchPayload()` にリマインダーフィールド追加
- [ ] 最も早い帰還時刻を使用（4隻の中で最小）
- [ ] メッセージ: `[N]隻帰還開始`

**受け入れ基準**:
- [ ] 最も早い帰還時刻でリマインダーが設定される
- [ ] メッセージに隻数が含まれる
- [ ] コマンドがコピペ可能

**テスト**:
- [ ] 単体テスト: 最小時刻選択のロジック確認

---

### 3.4 設定UIにリマインダー設定追加
**優先度**: 中  
**見積もり**: 2時間  
**担当**: 開発者  
**依存**: 3.1

**概要**:  
通知設定フォームにリマインダー連携セクションを追加。

**実装内容**:
- [ ] `NotificationMonitorWindowRenderer.SettingsLayout.cs` に追加
- [ ] チェックボックス: `EnableReminderCommand`
- [ ] テキスト入力: `ReminderChannelName`
- [ ] ヘルプテキスト表示
- [ ] デフォルト値: OFF, "#submarine"

**受け入れ基準**:
- [ ] チェックボックスが表示される
- [ ] チャンネル名が入力できる
- [ ] 設定が保存される
- [ ] UIレイアウトが整っている

**テスト**:
- [ ] E2Eテスト: 設定フォームの操作

---

## タスク4: テスト実装

### 4.1 単体テスト: フォーマッター
**優先度**: 高  
**見積もり**: 3時間  
**担当**: 開発者  
**依存**: 2.1, 2.2, 2.3, 3.1

**概要**:  
新しいフォーマットロジックの包括的な単体テストを作成。

**テストケース**:
- [ ] TC-1: `FormatRemainingConcise()` の各フォーマット
  - 25m, 1h, 1.5h, 12h, 12.5h
- [ ] TC-2: 単体通知フォーマット（Underway）
- [ ] TC-3: 単体通知でCompleted例外
- [ ] TC-4: バッチ通知フォーマット（1隻、4隻）
- [ ] TC-5: バッチ通知でCompleted例外
- [ ] TC-6: リマインダーコマンド生成
- [ ] TC-7: メッセージサニタイズ
- [ ] TC-8: エッジケース（null, 境界値）

**受け入れ基準**:
- [ ] すべてのテストがパス
- [ ] コードカバレッジ 95%以上
- [ ] テスト実行時間 < 2秒

**成果物**:
- [ ] `VoyageNotificationFormatterTests.cs` (新規または拡張)

---

### 4.2 単体テスト: 通知フィルタリング
**優先度**: 高  
**見積もり**: 2時間  
**担当**: 開発者  
**依存**: 1.1

**概要**:  
Completed通知がフィルタされることを検証。

**テストケース**:
- [ ] TC-1: Completed状態で通知が送信されない
- [ ] TC-2: Underway状態で通知が送信される
- [ ] TC-3: バッチング時のCompleted除外

**受け入れ基準**:
- [ ] すべてのテストがパス
- [ ] モックで通知送信がコールされないことを確認

**成果物**:
- [ ] `VoyageCompletionProjectionTests.cs` (拡張)

---

### 4.3 E2Eテスト: 通知フォーマット
**優先度**: 中  
**見積もり**: 3時間  
**担当**: 開発者  
**依存**: 2.2, 2.3, 3.2, 3.3, 3.4

**概要**:  
Playwrightで新しい通知フォーマットを検証。

**テストケース**:
- [ ] TC-1: 単体通知のフィールド数確認（1-2個）
- [ ] TC-2: バッチ通知の行数確認（4-5行）
- [ ] TC-3: リマインダーコマンドの表示（設定ON時）
- [ ] TC-4: リマインダーなし（設定OFF時）
- [ ] TC-5: Completed通知が送信されないこと

**受け入れ基準**:
- [ ] すべてのテストがパス
- [ ] スクリーンショット証跡
- [ ] テストが安定（フレーキーでない）

**成果物**:
- [ ] `notification-layout.spec.ts` に追加

---

## タスク5: ドキュメント整備

### 5.1 READMEの更新
**優先度**: 中  
**見積もり**: 1時間  
**担当**: 開発者  
**依存**: 3.4

**概要**:  
README.md に通知最適化とリマインダー連携の説明を追加。

**実装内容**:
- [ ] 「通知設定」セクションを更新
- [ ] リマインダー連携の使い方を追加
- [ ] スクリーンショット（オプション）

**受け入れ基準**:
- [ ] リマインダー連携の説明が明確
- [ ] 使い方の手順が記載されている

---

### 5.2 CHANGELOG更新
**優先度**: 低  
**見積もり**: 30分  
**担当**: 開発者  
**依存**: すべて

**概要**:  
CHANGELOG.md に変更内容を記録。

**実装内容**:
- [ ] `## [Unreleased]` セクションに追加
- [ ] Changed: Completed通知の廃止
- [ ] Changed: 通知フォーマットの簡素化
- [ ] Added: Discord Reminder Bot 連携（オプション）

---

## タスク6: リリース準備

### 6.1 マイグレーションガイド作成
**優先度**: 低  
**見積もり**: 1時間  
**担当**: 開発者  
**依存**: すべて

**概要**:  
既存ユーザー向けのマイグレーションガイドを作成。

**実装内容**:
- [ ] 変更内容の説明
- [ ] Before/After の比較
- [ ] リマインダー設定の手順
- [ ] FAQ

**成果物**:
- [ ] `MIGRATION_DISCORD_OPTIMIZATION.md`

---

### 6.2 コードレビュー
**優先度**: 高  
**見積もり**: 2時間  
**担当**: レビュアー  
**依存**: 1.3, 2.3, 3.3, 4.3

**レビュー観点**:
- [ ] コーディング規約準拠
- [ ] パフォーマンス影響なし
- [ ] テストカバレッジ 90%以上
- [ ] 後方互換性の確認
- [ ] ドキュメント整備

---

### 6.3 リリース判断
**優先度**: 高  
**見積もり**: 1時間  
**担当**: プロダクトオーナー  
**依存**: 6.2

**判断基準**:
- [ ] すべての受け入れ基準を満たす
- [ ] CI/CDパス
- [ ] ユーザー影響を評価
- [ ] リリースノート準備

---

## タスク依存関係図

```
Phase 1: Completed通知停止
  1.1 通知フィルタ ────────┐
    ↓                      │
  1.2 UI削除              │
    ↓                      │
  1.3 Deprecated化        │
    ↓                      │
  4.2 単体テスト          │
                          │
Phase 2: フォーマット簡素化│
  2.1 FormatRemaining ────┤
    ↓                      │
  2.2 単体フォーマット    │
    ↓                      │
  2.3 バッチフォーマット  │
    ↓                      │
  4.1 単体テスト          │
                          │
Phase 3: Reminder Bot統合 │
  3.1 FormatCommand ──────┤
    ↓                      │
  3.2 単体統合            │
    ↓                      │
  3.3 バッチ統合          │
    ↓                      │
  3.4 UI設定              │
    ↓                      │
  4.3 E2Eテスト          │
                          │
Phase 4: 仕上げ           │
  5.1 README更新          │
    ↓                      │
  5.2 CHANGELOG更新       │
    ↓                      │
  6.1 マイグレーション    │
    ↓                      │
  6.2 コードレビュー ←────┘
    ↓
  6.3 リリース判断
```

---

## 見積もりサマリー

### フェーズ別見積もり

| フェーズ | タスク数 | 合計時間 | 優先度 |
|----------|---------|---------|--------|
| Phase 1: Completed停止 | 3 | 3.5h | 高 |
| Phase 2: フォーマット簡素化 | 3 | 8h | 高 |
| Phase 3: Reminder統合 | 4 | 7h | 中 |
| Phase 4: テスト | 3 | 8h | 高 |
| Phase 5: ドキュメント | 2 | 1.5h | 中/低 |
| Phase 6: リリース | 3 | 4h | 高 |
| **合計** | **18** | **32h** | - |

**推定期間**: 4-5営業日（1日6-8時間換算）

---

## 実装順序（推奨）

### Week 1: コア機能（Phase 1-2）

**Day 1**: Completed通知停止
- AM: タスク 1.1 (2h)
- PM: タスク 1.2 (1h) + 1.3 (0.5h) + 4.2 (2h)

**Day 2**: フォーマット簡素化
- AM: タスク 2.1 (2h) + 2.2 (3h) 開始
- PM: タスク 2.2 完了 + 2.3 (3h)

**Day 3**: テスト
- AM: タスク 4.1 (3h)
- PM: 予備時間、バグ修正

---

### Week 2: Reminder統合とリリース（Phase 3-6）

**Day 4**: Reminder Bot統合
- AM: タスク 3.1 (2h) + 3.2 (1.5h)
- PM: タスク 3.3 (1.5h) + 3.4 (2h)

**Day 5**: テストとドキュメント
- AM: タスク 4.3 (3h)
- PM: タスク 5.1 (1h) + 5.2 (0.5h) + 6.1 (1h)

**Day 6**: リリース準備
- AM: タスク 6.2 (2h)
- PM: タスク 6.3 (1h) + 予備時間

---

## リスクと軽減策

| リスク | 影響 | 確率 | 軽減策 | 担当タスク |
|--------|------|------|--------|-----------|
| ユーザーがCompleted通知削除に反発 | 中 | 低 | リリースノートで説明、フィーチャーフラグ | 6.1 |
| Reminder Botのコマンド仕様変更 | 低 | 低 | ドキュメント確認、テストで検証 | 3.1 |
| バッチ通知の視認性低下 | 低 | 低 | inline設定で調整、スクリーンショット確認 | 2.3 |
| テスト更新漏れ | 中 | 中 | 既存テスト全件レビュー、CI確認 | 4.1-4.3 |
| 設定マイグレーション問題 | 低 | 低 | 後方互換性維持、Obsolete使用 | 1.3 |

---

## 成功基準

### 必須（Must Have）
- [ ] Completed通知が送信されない
- [ ] 単体通知が1フィールドのみ
- [ ] バッチ通知が1行×N隻
- [ ] すべてのテストがパス
- [ ] CI/CDパス

### 推奨（Should Have）
- [ ] リマインダーコマンド機能実装
- [ ] 設定UIが使いやすい
- [ ] ドキュメント完備

### オプション（Nice to Have）
- [ ] 絵文字対応
- [ ] リマインダーコマンドのカスタマイズ機能
- [ ] マイグレーションガイドの充実

---

## マイルストーン

### マイルストーン1: コア機能完了（Day 3終了時）
- [ ] Completed通知停止
- [ ] フォーマット簡素化
- [ ] 単体テスト完了
- [ ] ビルド成功

### マイルストーン2: 統合完了（Day 5終了時）
- [ ] Reminder Bot統合
- [ ] 設定UI完成
- [ ] E2Eテスト完了
- [ ] ドキュメント整備

### マイルストーン3: リリース準備完了（Day 6終了時）
- [ ] コードレビュー完了
- [ ] マイグレーションガイド作成
- [ ] リリース判断

---

## 段階的リリース戦略

### リリース1: 最小機能（Phase 1-2のみ）
- Completed通知停止
- フォーマット簡素化
- リマインダーなし

**メリット**: 早期にフィードバック取得

### リリース2: 完全版（Phase 1-3）
- リリース1 + リマインダー統合

**タイミング**: リリース1の1-2週間後

---

## 完了チェックリスト

### 実装完了
- [ ] すべてのタスク完了
- [ ] コードレビューパス
- [ ] すべてのテストがパス（単体 + E2E）

### 品質保証
- [ ] コードカバレッジ 90%以上
- [ ] ビルド成功（0警告、0エラー）
- [ ] CI/CDパス
- [ ] パフォーマンス影響なし（60fps維持）

### ドキュメント
- [ ] README更新
- [ ] CHANGELOG更新
- [ ] マイグレーションガイド作成

### リリース準備
- [ ] バージョン番号決定（1.2.0 推奨）
- [ ] リリースノート作成
- [ ] ユーザー通知計画

---

**作成日**: 2025-10-26  
**見積もり精度**: ±20%  
**優先順位**: Phase 13 実施推奨  
**次のステップ**: タスク 1.1 から実装開始

