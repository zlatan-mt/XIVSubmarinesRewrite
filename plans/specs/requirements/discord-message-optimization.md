# 要件定義: Discord通知メッセージの最適化

## 概要

Discord通知を出航時のみに限定し、メッセージ内容を「次に帰還するのはいつか」が一目で分かる最小限の情報に絞り込む。

## 背景

### ユーザーからのフィードバック
- **不要な通知**: 帰還通知は必要ない（ゲーム内で確認するため）
- **本当に必要な情報**: 出航させたときに「いつ帰ってくるか」だけ知りたい
- **現状の問題**: 情報が多すぎて、肝心の帰還時刻が埋もれる

### 現在の課題
1. **通知頻度**: 出航時と帰還時の2回通知（帰還は不要）
2. **情報過多**: 6-12個のフィールド（必要なのは帰還時刻のみ）
3. **冗長性**: タイトル・説明・フィールドで情報が重複
4. **認知負荷**: 通知を見てから帰還時刻を探す手間

## 機能要件

### FR-1: 帰還通知の廃止
**優先度**: 高

**説明**: `VoyageStatus.Completed` の通知を送信しない。

**理由**:
- ユーザーはゲーム内で帰還を確認する
- 帰還通知は情報価値が低い
- 通知数を半減できる

**実装箇所**:
- `NotificationCoordinator` または `VoyageCompletionProjection`
- 設定で無効化するのではなく、完全に送信ロジックから除外

**受け入れ基準**:
- [ ] Completed通知が送信されない
- [ ] Underway通知は正常に送信される
- [ ] 既存の設定（NotifyVoyageCompleted）は削除またはUI非表示

---

### FR-2: 出航通知の簡素化（単体）
**優先度**: 高

**説明**: 1隻の出航通知を最小限の情報に絞る。

**新フォーマット**:
```
タイトル: [潜水艦名] 出航
説明: [航路名]
フィールド:
- 帰還予定: [日時] ([残り時間])
```

**例**:
```
タイトル: Sub-1 出航
説明: Sea of Ash 1
フィールド:
- 帰還予定: 10/26(土) 14:30 (12時間後)
```

**削除する情報**:
- ❌ キャラクター名（タイトルまたはusernameで分かる）
- ❌ 出航時刻（今出航したので不要）
- ❌ 信頼度（内部情報）
- ❌ 「が航海を開始しました」という説明文（冗長）

**受け入れ基準**:
- [ ] タイトルが `[潜水艦名] 出航` 形式
- [ ] 説明が航路名のみ（1行）
- [ ] フィールドが1個のみ（帰還予定）
- [ ] 帰還予定に残り時間が併記される

---

### FR-3: 出航通知の簡素化（バッチ）
**優先度**: 高

**説明**: 4隻の出航通知を1行×4隻の簡潔な形式にする。

**新フォーマット**:
```
タイトル: [キャラクター名] - 4隻出航
説明: (空欄または「すべて出航完了」)
フィールド:
- Sub-1: 10/26 14:30 (12h)
- Sub-2: 10/26 15:00 (12.5h)
- Sub-3: 10/26 16:30 (14h)
- Sub-4: 10/26 18:00 (15.5h)
```

**削除する情報**:
- ❌ 航路名（各潜水艦の詳細行から）
- ❌ 「次の帰港予定を確認してください」という説明（冗長）
- ❌ 3行形式の詳細（航路、帰港、残り → 1行に集約）

**受け入れ基準**:
- [ ] タイトルがキャラクター名と隻数
- [ ] 各潜水艦が1行で表示（潜水艦名: 日時 (残り時間)）
- [ ] スクロールなしで全体が見える
- [ ] 日時フォーマットが統一（MM/dd HH:mm）

---

### FR-4: 残り時間の簡潔な表示
**優先度**: 中

**説明**: 残り時間を短い形式で表示する。

**フォーマット**:
- `12時間後` → `12h`
- `30分後` → `30m`
- `12時間 30分後` → `12.5h`
- `1日12時間後` → `36h` または `1d12h`

**受け入れ基準**:
- [ ] 時間単位は `h`
- [ ] 分単位は `m`（1時間未満の場合）
- [ ] 日単位は `d`（オプション）
- [ ] 小数点1桁まで許容（例: 12.5h）

---

### FR-5: Discord Reminder Bot 統合（オプション）
**優先度**: 低（将来の拡張）

**説明**: Discord Reminder Bot と連携し、帰還時刻にリマインダーを自動設定する。

**実装方式の候補**:

#### 方式A: コマンド提示（推奨・簡単）
通知にリマインダー設定コマンドを含め、ユーザーがコピペで実行。

**通知例**:
```
タイトル: Sub-1 出航
説明: Sea of Ash 1
フィールド:
- 帰還予定: 10/26 14:30 (12h)
- リマインダー: `/remind #submarine 10/26 14:30 Sub-1が帰還`
```

**必要な変更**:
- `VoyageNotificationFormatter` にリマインダーコマンドフィールド追加
- 設定で有効/無効化
- チャンネル名を設定可能に

**受け入れ基準**:
- [ ] 通知にリマインダーコマンドが含まれる
- [ ] コマンドがコピペで実行可能
- [ ] 日時フォーマットが Reminder Bot の仕様に準拠
- [ ] 設定でON/OFF可能

#### 方式B: Bot API 統合（高度・複雑）
Discord Bot を自作し、リマインダーを自動設定。

**技術要件**:
- Discord Bot Token
- Reminder Bot API（または独自リマインダー実装）
- Channel ID の設定
- Bot権限の管理

**受け入れ基準**:
- [ ] 出航時にリマインダーが自動設定される
- [ ] ユーザー操作不要
- [ ] リマインダー編集・削除も可能

**採用判断**:
- Phase 13 では方式A（コマンド提示）を実装
- Phase 14以降で方式B（Bot API）を検討

---

## 非機能要件

### NFR-1: 後方互換性
**優先度**: 低

**説明**: 既存のユーザーへの影響を最小化。

**考慮事項**:
- 通知フォーマット変更は破壊的変更ではない（受信側に影響なし）
- 設定の移行は不要（NotifyVoyageCompletedは削除またはdeprecated）

---

### NFR-2: 保守性
**優先度**: 高

**説明**: コードの可読性と保守性を維持。

**要件**:
- フォーマットロジックを独立したメソッドに分離
- 単体テストでフォーマット結果を検証
- マジックナンバーや文字列を定数化

---

### NFR-3: 拡張性
**優先度**: 中

**説明**: 将来のカスタマイズに対応。

**考慮事項**:
- テンプレート化（将来的にユーザーが編集可能に）
- 絵文字の有効/無効化（設定で切り替え可能に）

---

## ユースケース

### UC-1: 1隻出航時の通知確認
**アクター**: プレイヤー

**前提条件**:
- 潜水艦1隻を出航させた
- Discord通知が有効

**主フロー**:
1. プレイヤーが工房で潜水艦を出航させる
2. システムが出航を検知
3. システムがDiscord通知を送信
4. プレイヤーがスマホでDiscord通知を確認
5. プレイヤーが帰還時刻を一目で把握（「10/26 14:30」）
6. プレイヤーがその時刻にゲームにログイン

**期待結果**: 3秒以内に帰還時刻が分かる

---

### UC-2: 4隻一括出航時の通知確認
**アクター**: プレイヤー（複数キャラクター運用）

**前提条件**:
- 4隻すべてを一度に出航させた
- Discord通知が有効

**主フロー**:
1. プレイヤーが4隻を出航
2. システムが4隻分を集約
3. システムがバッチ通知を送信
4. プレイヤーがスマホで確認
5. プレイヤーが4隻の帰還時刻を一覧で把握
6. プレイヤーが最も早い帰還時刻をメモ

**期待結果**: スクロールなしで全情報が見える

---

## 制約

### 技術的制約
- Discord Webhook API の制限
  - embed最大10個
  - field最大25個
  - 文字数制限（title: 256, description: 4096, field.value: 1024）

### 既存実装の制約
- `VoyageNotificationFormatter` を修正
- `DiscordNotificationPayload` の構造は維持
- 通知バッチング機能（4隻集約）は維持

---

## データモデル変更

### 不要になるデータ
- `Completed` 通知の送信ロジック
- `NotifyVoyageCompleted` 設定フラグ（UI削除）

### 変更が必要なデータ
- `VoyageNotificationFormatter.CreateDiscordPayload()`: Underway専用に簡素化
- `VoyageNotificationFormatter.CreateDiscordBatchPayload()`: 1行フォーマットに変更

---

## 影響範囲

### 変更対象ファイル
1. **VoyageNotificationFormatter.cs**
   - `CreateDiscordPayload()`: フィールド削減（6個→1個）
   - `CreateDiscordBatchPayload()`: 3行→1行フォーマット
   - `BuildDiscordFields()`: 削除または大幅簡素化
   - `BuildBatchLines()`: 1行フォーマットに変更

2. **NotificationCoordinator.cs または VoyageCompletionProjection.cs**
   - Completed通知の送信ロジックを削除

3. **NotificationSettings.cs**
   - `NotifyVoyageCompleted` フラグを削除またはdeprecated

4. **UI（通知設定フォーム）**
   - 「帰港時に通知」チェックボックスを削除

### 影響を受ける機能
- **通知送信**: Completed通知が停止
- **通知設定UI**: チェックボックス削除
- **既存ユーザー**: 設定マイグレーション（自動でUnderway通知のみに）

---

## 受け入れ基準

### AC-1: Completed通知の廃止
- [ ] Completed通知が送信されない
- [ ] Underway通知は正常に送信される
- [ ] 既存の設定（NotifyVoyageCompleted）がUI上で非表示
- [ ] 設定ファイルにNotifyVoyageCompletedが残っていても動作に影響なし

### AC-2: 単体通知の簡素化
- [ ] タイトル: `[潜水艦名] 出航`
- [ ] 説明: `[航路名]` のみ
- [ ] フィールド: `帰還予定: [日時] ([残り時間])` のみ
- [ ] フィールド数が1個
- [ ] 文字数が50%以上削減

### AC-3: バッチ通知の簡素化
- [ ] タイトル: `[キャラクター名] - [N]隻出航`
- [ ] 説明: 空欄またはシンプルな1行
- [ ] 各潜水艦: `潜水艦名: 日時 (残り時間)` の1行形式
- [ ] 12行 → 4行に削減
- [ ] スクロールなしで全体表示

### AC-4: 残り時間表記
- [ ] 時間: `12h` 形式
- [ ] 分: `30m` 形式（1時間未満）
- [ ] 小数点: `12.5h` 形式（30分単位の場合）

### AC-5: 視認性
- [ ] Discord上で見やすい
- [ ] スマホでも読みやすい
- [ ] 重要情報（帰還時刻）が目立つ

---

## テストシナリオ

### TS-1: 1隻出航の通知確認
```
Given: 潜水艦1隻を出航させる
When: Discord通知を受信
Then: 
  - タイトルが「Sub-1 出航」
  - 帰還予定時刻が表示される
  - フィールドが1個のみ
  - Completed通知は送信されない
```

### TS-2: 4隻一括出航の通知確認
```
Given: 4隻すべてを出航させる
When: Discord通知を受信（バッチ）
Then:
  - タイトルに隻数が含まれる
  - 4隻の帰還時刻が1行ずつ表示される
  - スクロールなしで全体が見える
```

### TS-3: 帰還時の通知なし確認
```
Given: 潜水艦が帰還する
When: 帰還イベントが発生
Then: Discord通知が送信されない
```

---

## ビフォー・アフター比較

### Before（現状 - 単体通知）
```
タイトル: Sub-1 帰港
説明: Sub-1 が航海を完了しました。

キャラクター: Mona
航路: Sea of Ash 1
出航: 10/25(金) 14:00
帰港: 10/26(土) 02:00
経過: 完了 (12時間前)
信頼度: High
```
**文字数**: 約120文字  
**フィールド**: 6個  
**認知負荷**: 高（帰還時刻を探す必要）

### After（改善後 - 単体通知）
```
タイトル: Sub-1 出航
説明: Sea of Ash 1

帰還予定: 10/26(土) 02:00 (12h)
```
**文字数**: 約40文字（67%削減）  
**フィールド**: 1個（83%削減）  
**認知負荷**: 低（帰還時刻が即座に分かる）

---

### Before（現状 - バッチ通知）
```
タイトル: 4 隻が帰港
説明: Mona の潜水艦 4 隻が帰港しました。

Sub-1:
  航路: Route-A
  帰港: 10/26(土) 02:00
  経過: 完了 (12時間前)

Sub-2:
  航路: Route-B
  帰港: 10/26(土) 03:00
  経過: 完了 (11時間前)

[以下2隻略]
```
**行数**: 12行（3行×4隻）  
**スクロール**: 必要

### After（改善後 - バッチ通知）
```
タイトル: Mona - 4隻出航

Sub-1: 10/26 14:30 (12h)
Sub-2: 10/26 15:00 (12.5h)
Sub-3: 10/26 16:30 (14h)
Sub-4: 10/26 18:00 (15.5h)
```
**行数**: 4行（1行×4隻、67%削減）  
**スクロール**: 不要

---

## リスク分析

### ユーザー影響
| リスク | 影響 | 確率 | 軽減策 |
|--------|------|------|--------|
| 帰還通知削除に不満 | 中 | 低 | リリースノートで説明、設定で復活可能に |
| 情報不足の訴え | 中 | 低 | 航路名は残す、要望に応じて追加 |
| 慣れの問題 | 低 | 中 | 段階的ロールアウト |

### 技術的リスク
| リスク | 影響 | 確率 | 軽減策 |
|--------|------|------|--------|
| 設定マイグレーション失敗 | 低 | 低 | 既存設定を読むが、無視するだけ |
| バッチング動作の変更 | 低 | 低 | ロジック変更なし、フォーマットのみ |
| テスト更新漏れ | 中 | 中 | 既存テストを全て確認 |

---

## 成功指標

### 定量的指標
- [ ] 通知文字数: 50%以上削減
- [ ] 通知頻度: 50%削減（帰還通知廃止）
- [ ] フィールド数: 単体6個→1個、バッチ12行→4行

### 定性的指標
- [ ] ユーザーフィードバック: 「分かりやすくなった」
- [ ] 認知負荷: 帰還時刻が即座に分かる
- [ ] 満足度: 通知が邪魔にならない

---

## 参考資料

### 既存実装
- `VoyageNotificationFormatter.cs`: 127-154行（BuildDiscordFields）
- `VoyageNotificationFormatter.cs`: 81-125行（CreateDiscordBatchPayload）
- `VoyageNotificationFormatter.cs`: 156-166行（BuildBatchLines）

### Discord Webhook仕様
- Embed title: 最大256文字
- Embed description: 最大4096文字
- Field value: 最大1024文字
- Fields: 最大25個

---

**作成日**: 2025-10-26  
**関連Phase**: Phase 13候補  
**優先度**: 中  
**次のステップ**: `/kiro:spec-design discord-message-optimization`

