# XIV Submarines Rewrite v1.1.6 リリースノート

**リリース日**: 2025年1月27日  
**対応API**: Dalamud API Level 13  
**フレームワーク**: .NET 9.0-windows

---

## 🎯 このリリースについて

v1.1.6では、Discord通知の表示を改善し、重複潜水艦問題を修正しました。ユーザーフィードバックに基づき、通知の可読性と正確性を向上させました。

**主な改善点**:
- Discord通知レイアウトの改善（帰還時刻の整列表示）
- 重複潜水艦問題の修正（3隻目と4隻目が同じになる問題を解決）
- デバッグ機能の強化（問題の原因特定を容易に）

---

## ✨ 改善点

### Discord通知レイアウトの改善

**変更前**:
- 潜水艦名の長さが異なるため、帰還時刻が横にズレて見づらい
- 3隻が1行、1隻が1行と2行に分かれて表示される

**変更後**:
- 最も遅い帰還時刻を大きく表示（太字で強調）
- 全潜水艦の帰還時刻が縦に整列して表示される
- コードブロックを使用して等幅フォントで表示し、確実に整列

**表示例**:
```
**🟠 帰還時間: 11/8(土) 12:05**

```
Bonfire 11/8(土) 12:04
Siipi   11/8(土) 12:04
Pilvi   11/8(土) 12:05
Kukka   11/8(土) 12:05
```
```

---

## 🐛 バグ修正

### 重複潜水艦問題の修正

**問題**:
- 4隻出航時に、3隻目と4隻目が全く同じ内容で表示される
- 同じSubmarineIdの通知が重複して処理される

**修正内容**:
- Slot番号の正規化（0-3の範囲に制限）
  - メモリソースでSlot番号が1-5の範囲だった問題を修正
  - すべてのデータソースで0-3の範囲に統一
- 重複検出ロジックの追加
  - 同じSubmarineIdの通知が複数ある場合に警告ログを出力
  - 無効なSlot番号（4以上）を検出して警告
- 詳細なデバッグログの追加
  - SubmarineId、Slot、HashKeyを記録
  - 問題の原因特定を容易に

---

## 🔧 技術的改善

### デバッグ機能の強化

- **詳細ログの追加**:
  - `DiscordCycleNotificationAggregator`にSubmarineId、Slot、HashKey、ArrivalUtcを記録
  - 既存の通知が上書きされる場合に警告ログを出力
  - 集約結果の詳細ログ（各潜水艦のSlot番号とラベル）

- **重複検出**:
  - `TryCreateAggregate`で重複を検出して警告ログを出力
  - `BuildAggregateDecision`で最終的な重複チェックを実施

---

## 📋 変更ファイル

### ソースコード
- `src/Application/Notifications/VoyageNotificationFormatter.cs`
  - バッチ通知のレイアウト改善
  - コードブロックを使用した整列表示

- `src/Application/Notifications/DiscordCycleNotificationAggregator.cs`
  - 詳細ログの追加
  - 重複検出ロジックの追加
  - Slot番号の検証ロジックの追加

- `src/Infrastructure/Acquisition/DalamudMemorySubmarineSnapshotSource.cs`
  - Slot番号の正規化（0-3の範囲に制限）

---

## 🔄 アップグレード手順

既存のv1.1.5からアップグレードする場合、特別な手順は不要です。

1. Dalamud Plugin Installerから最新版をインストール
2. プラグインを再読み込み
3. 通知設定はそのまま維持されます

---

## 📊 パフォーマンス

- 通知生成時間: 既存と同等（< 10ms）
- メモリ使用: 既存と同等
- ログ出力: デバッグログが追加されましたが、本番環境ではTrace/Debugレベルは無効化されます

---

## 🧪 テスト

- 既存のテストケースはすべて通過
- 新しいログ機能は本番環境でのパフォーマンスに影響しません

---

## 📝 既知の制限

- Discordのembed descriptionでは、テキストの色を直接変更することはできません
- そのため、オレンジの絵文字（🟠）で色を表現しています

---

## 🙏 謝辞

ユーザーのフィードバックに基づき、通知の可読性と正確性を向上させることができました。ご報告いただき、ありがとうございます。

---

## 📚 関連資料

- [CHANGELOG.md](CHANGELOG.md) - 詳細な変更履歴
- [README.md](README.md) - 使用方法と設定

---

**次のリリース予定**: 未定  
**フィードバック**: GitHub Issues または Discord でお知らせください

